Okay, here is korona's guide for locking in a kernel: whenever you take a spinlock that is remotely touched directly or indirectly by any IRQ, you have to disable IRQs before taking a lock. When in doubt, a spinlock is (at least indirectly) touched by your IRQs. Unless you are really, really sure that it isn't, just disable IRQs while taking spinlocks. In particular, just disable IRQs when you take any spinlock in your kernel. Do not try to outsmart this rule unless you thought about this really well. Linux does this (for 99% of all spinlocks), Managarm does this, you should also just do it. If you think it's all simple and you don't need to disable IRQs for a particular lock, the chance is high that you're wrong. I've been doing lock-free programming professionally for 5 years now and even I am often wrong. So just disable IRQs when taking a spinlock.
